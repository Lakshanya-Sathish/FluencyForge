<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Writing Practice | FluencyForge</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      background: linear-gradient(135deg, #e6f0ff, #faf6ff);
      padding: 0;
      margin: 0;
      font-family: "Poppins", sans-serif;
    }

    .container {
      max-width: 900px;
      margin: 100px auto;
      background: #fff;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.08);
    }

    h1 {
      text-align: center;
      color: #374785;
      margin-bottom: 10px;
    }

    .prompt-box {
      background: #f8f8ff;
      padding: 15px;
      border-left: 5px solid #6b5b95;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 1rem;
    }

    #response {
      width: 100%;
      min-height: 170px;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 12px;
      font-size: 1rem;
      resize: vertical;
    }

    #submitBtn {
      margin-top: 15px;
      background: #6c5ce7;
      border: none;
      padding: 12px 22px;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-size: 1.1rem;
      transition: 0.3s ease;
      width: 100%;
    }

    #submitBtn:hover {
      background: #4b39c4;
    }

    #resultMsg {
      text-align: center;
      font-weight: 600;
      color: #27ae60;
      margin-top: 10px;
      display: none;
    }

    #aiFeedbackBox {
      display:none;
      margin-top:20px;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
    }

    #aiFeedbackBox h3 {
      margin-bottom: 8px;
      color:#5c6bc0;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>‚úç Writing Practice</h1>

    <div class="prompt-box" id="writingPrompt">Loading prompt...</div>

    <textarea id="response" placeholder="Write your response here..."></textarea>

    <button id="submitBtn">Submit Response</button>

    <p id="resultMsg">Response submitted successfully ‚úî</p>

    <!-- AI FEEDBACK BOX -->
    <div id="aiFeedbackBox">
      <h3>AI Feedback ü§ñ</h3>
      <p id="feedbackText">Your writing is being analyzed...</p>
    </div>
  </div>

  <script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
  import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  const promptBox = document.getElementById("writingPrompt");
  const submitBtn = document.getElementById("submitBtn");
  const responseInput = document.getElementById("response");
  const resultMsg = document.getElementById("resultMsg");
  const aiBox = document.getElementById("aiFeedbackBox");
  const feedbackText = document.getElementById("feedbackText");

  let userId = null;

  async function loadPrompt(level) {
    const snap = await getDoc(doc(db, "content", "writing"));
    if (snap.exists()) {
      const data = snap.data();
      promptBox.textContent = data[level][0];
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "index.html";

    userId = user.uid;
    const snap = await getDoc(doc(db, "users", userId));
    const level = snap.exists() ? snap.data().level : "beginner";

    await loadPrompt(level);
  });

  // ---- AI FEEDBACK ENGINE (Placeholder but structured) ----
  function generateMockFeedback(text) {
    const score = Math.floor(Math.random() * 11) + 15; // random 15‚Äì30 for placeholder

    return `
      ‚≠ê <strong>TOEFL Score:</strong> ${score}/30\n\n
      üìå <strong>Strengths:</strong> Clear structure, relevant ideas.\n
      ‚ö†Ô∏è <strong>Weaknesses:</strong> Limited vocabulary, repetitive phrasing.\n\n
      ‚úç <strong>Suggested Rewrite:</strong>\n
      "${text.slice(0, 100)}..."\n\n
      üî• <strong>Brutal Truth:</strong> Good effort, but you‚Äôre still writing like a school exam. Add richer vocabulary and vary sentence structure.
    `;
  }

  async function triggerAIFeedback(text){
    aiBox.style.display = "block";
    feedbackText.textContent = "‚è≥ Analyzing...";

    setTimeout(() => {
      feedbackText.innerHTML = generateMockFeedback(text).replace(/\n/g, "<br>");
    }, 1200);
  }

  submitBtn.addEventListener("click", async () => {
    const text = responseInput.value.trim();
    if (text.length < 40) {
      alert("Write at least 40+ words. This isn't WhatsApp.");
      return;
    }

    resultMsg.style.display = "block";
    triggerAIFeedback(text);

    await updateDoc(doc(db, "users", userId), {
      writingSubmitted: true
    });
  });
</script>
</body>
</html>
