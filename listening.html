<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Listening Practice | FluencyForge</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  background:#f6f8ff;
  font-family:Poppins,sans-serif;
  margin:0;
}
.container{
  max-width:900px;
  margin:40px auto;
  background:#fff;
  padding:30px;
  border-radius:16px;
}
h1,h2{margin-top:0}
.question{margin:20px 0}
label{display:block;margin:6px 0;cursor:pointer}
button{
  margin-top:20px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#4a90e2;
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
audio{
  width:100%;
  margin:15px 0;
}
.result{
  margin-top:20px;
  font-weight:600;
  text-align:center;
}
.hidden{display:none}
</style>
</head>

<body>

<div class="container">
  <h1 id="title">Listening Practice</h1>

  <audio id="audio" controls></audio>

  <div id="questions"></div>

  <button id="submitBtn">Submit</button>
  <div class="result" id="result"></div>

  <button onclick="location.href='listening-modules.html'">â¬… Back to Modules</button>
</div>

<script>
let correctAnswers = [];

const params = new URLSearchParams(window.location.search);
const currentLevel = params.get("level");
const taskParam = params.get("task");
const currentTaskIndex = parseInt(taskParam, 10) - 1;

if (!currentLevel || isNaN(currentTaskIndex)) {
  alert("Invalid listening task");
  throw new Error("Invalid params");
}

async function loadListening(){
  try{
    const res = await fetch(`content/listening/${currentLevel}.json`);
    const data = await res.json();

    const task = data.tasks[currentTaskIndex];
    if (!task) {
      alert("Listening task not found");
      return;
    }

    document.getElementById("title").textContent = task.title;

    const audio = document.getElementById("audio");
    audio.src = task.audio;

    const qBox = document.getElementById("questions");
    qBox.innerHTML = "";
    correctAnswers = [];

    task.questions.forEach((q,i)=>{
      correctAnswers.push(q.answer);
      qBox.innerHTML += `
        <div class="question">
          <h3>${i+1}. ${q.question}</h3>
          ${Object.entries(q.options).map(([k,v])=>`
            <label>
              <input type="radio" name="q${i}" value="${k}">
              (${k}) ${v}
            </label>
          `).join("")}
        </div>
      `;
    });

  } catch(err){
    console.error(err);
    alert("Failed to load listening content");
  }
}

document.getElementById("submitBtn").addEventListener("click",()=>{
  let score = 0;

  correctAnswers.forEach((ans,i)=>{
    const sel = document.querySelector(`input[name="q${i}"]:checked`);
    if(sel && sel.value === ans) score++;
  });

  const percent = Math.round((score / correctAnswers.length) * 100);
  document.getElementById("result").textContent =
    `Score: ${score}/${correctAnswers.length} (${percent}%)`;

  let progress = JSON.parse(localStorage.getItem("listeningProgress")) || {};
  progress[currentLevel] = percent;
  localStorage.setItem("listeningProgress", JSON.stringify(progress));
});

loadListening();
function initProgress() {
  if (!localStorage.getItem("progress")) {
    localStorage.setItem("progress", JSON.stringify({
      speaking: {
        beginner: false,
        intermediate: false,
        advanced: false
      },
      listening: {
        beginner: null,
        intermediate: null,
        advanced: null
      },
      reading: {
        beginner: null,
        intermediate: null,
        advanced: null
      }
    }));
  }
}
initProgress();
</script>

</body>
</html>
